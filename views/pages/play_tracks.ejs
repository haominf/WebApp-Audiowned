<!DOCTYPE html>
<html>
<head>
	<style>
		body {
		    padding: 20px;
		}
		#search-form, .form-control {
		    margin-bottom: 20px;
		}
		.cover {
		    width: 300px;
		    height: 300px;
		    display: inline-block;
		    background-size: cover;
		}
		.cover:hover {
		    cursor: pointer;
		}
		.cover.playing {
		    border: 5px solid #e45343;
		}
	</style>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
	<script>

		var albums;
		console.log("poo");
		$("#search-form").change(albums, function() {
			console.log($("#query").value);
		});
/*
		document.getElementById('search-form').addEventListener('submit', function (e) {
			searchAlbums(document.getElementById('query').value);
		}, false);

		var value = $("search-form").val();
*/



		var templateSource = $('results-template'),
			template = Handlebars.compile(templateSource),
			resultsPlaceholder = $('results'),
			playingCssClass = 'playing',
			audioObject = null;

		console.log("fetching");
		var fetchTracks = function (albumId, callback) {
			$.ajax({
				url: 'https://api.spotify.com/v1/albums/' + albumId,
				success: function (response) {
					callback(response);
				}
			});
		};

		var searchAlbums = function (query) {
			$.ajax({
				url: 'https://api.spotify.com/v1/search',
				data: {
					q: query,
					type: 'album'
				},
				success: function (response) {
					resultsPlaceholder.innerHTML = template(response);
				}
			});
		};

		results.addEventListener('click', function (e) {
			var target = e.target;
			if (target !== null && target.classList.contains('cover')) {
				if (target.classList.contains(playingCssClass)) {
					audioObject.pause();
				} else {
					if (audioObject) {
						audioObject.pause();
					}
					fetchTracks(target.getAttribute('data-album-id'), function (data) {
						audioObject = new Audio(data.tracks.items[0].preview_url);
						audioObject.play();
						target.classList.add(playingCssClass);
						audioObject.addEventListener('ended', function () {
							target.classList.remove(playingCssClass);
						});
						audioObject.addEventListener('pause', function () {
							target.classList.remove(playingCssClass);
						});
					});
				}
			}
		});

	</script>

</head>
<body>

		<div class="container">
			<h1>Search for an Artist</h1>
			<p>Type an artist name and click on "Search". Then, click on any album from the results to play 30 seconds of its first track.</p>
			<p id="search-form">
				<input type="text" id="query" value="" class="form-control" placeholder="Type an Artist Name"/>
				<input type="submit" id="search" class="btn btn-primary" value="Search" />
			</p>
			<div id="results"></div>
		</div>
		<div id="albums"></div>
		<script id="results-template" type="text/x-handlebars-template">
			{{#each albums.items}}
			<div style="background-image:url({{images.0.url}})" data-album-id="{{id}}" class="cover"></div>
			{{/each}}
		</script>

</body>
</html>
